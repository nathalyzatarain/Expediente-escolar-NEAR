<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expediente escolar</title>
  <script src="https://cdn.jsdelivr.net/npm/near-api-js@0.43.1/dist/near-api-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bn.js@5.2.0/lib/bn.min.js"></script>
</head>

<body>
  <nav>
    <div><a href="index.html">Inicio</a></div>
    <div><a href="login.html">Login</a></div>
    <div><a href="contract.html">contract</a></div>
  </nav>
  <hr />
  <button id="hello">Hello World</button>
  <br />
  <button id="read">read</button> <input type="text" id="read-key" placeholder="key" />
  <br />
  <button id="write">write</button> <input type="text" id="write-key" placeholder="key" /> <input type="text"
    id="write-value" placeholder="value" />

  <!-- Expediente escolar  -->
  <br><br>
  <button id="studentList">Ver estudiantes</button>
  <br />
  <button id="readId">Consultar por Nº de cuenta</button> <input type="text" id="read-id" placeholder="# cuenta" />
  <br />
  <button id="readName">Consultar por nombre</button> <input type="text" id="read-name" placeholder="Nombre" />
  <br />
  <button id="readCareer">Consultar por carrera</button> <input type="text" id="read-career" placeholder="Carrera" />
  <br />
  <button id="addStudent">Agregar estudiante</button> 
  <input type="number" id="id" placeholder="# Cuenta" /> 
  <input type="text" id="name" placeholder="Nombre" /> 
  <input type="date" id="date" placeholder="Fecha" />
  <input type="number" id="age" placeholder="Edad" />
  <input type="text" id="email" placeholder="Correo electronico" />
  <input type="text" id="phone" placeholder="Telefono" />
  <input type="text" id="country" placeholder="Nacionalidad" />
  <input type="text" id="career" placeholder="Carrera" />

  <script>
    (async () => {
      const { connect, keyStores, WalletConnection } = nearApi;

      const NETWORK = 'testnet';

      const CONTRACT_ID = 'dev-1656454287963-33635598317214';

      //const CONTRACT_ID = 'dev-1656452857908-99001344275282';
      //dev-1656452857908-99001344275282
      // const gas = new BN('1000'); // uncomment this line to see an error re: "Exceeded the prepaid gas"

      const near = await connect(config());
      const wallet = new WalletConnection(near, `${NETWORK}-custom-prefix`);

      const dom = setupDOMBindings();

      const contract = {
        //getEstudiantes: async () => await view(CONTRACT_ID, 'getEstudiantes'),
        helloWorld: async () => await view(CONTRACT_ID, 'getEstudiantes'),
        readKey: async () => await view(CONTRACT_ID, 'read', { key: dom.txtReadKey.value }),
        writeKey: async () => await change(CONTRACT_ID, 'setEstudiante', { nombre: "Kevin Estrada", fechaNacimiento: "2 de junio de 1997", edad: 24, email: "kevin@gmail.com", telefono: "6691017155", nacionalidad: "peru", carrera: "animacion" }, typeof gas !== 'undefined' ? gas : null),
        //writeKey: async () => await change(CONTRACT_ID, 'write', { key: dom.txtWriteKey.value, value: dom.txtWriteValue.value }, typeof gas !== 'undefined' ? gas : null)
        
        addStudent: async () => await change(CONTRACT_ID, 'setEstudiante', { nombre: "Maria Estrada", fechaNacimiento: "2 de junio de 1997", edad: 24, email: "maria@gmail.com", telefono: "6691017155", nacionalidad: "mexico", carrera: "psicologia" }, typeof gas !== 'undefined' ? gas : null),
        studentList: async () => await view(CONTRACT_ID, 'getEstudiantes'),
        getStudent: async () => await view(CONTRACT_ID, 'getEstudiante', { id: dom.txtgetByid.value }),
        getByName: async () => await view(CONTRACT_ID, 'getEstudiantesByName', { nombre: dom.txtgetByName.value }),
        getByCareer: async () => await view(CONTRACT_ID, 'getEstudianteByCareer', { carrera: dom.txtgetByCareer.value }),
      };

      if (wallet.isSignedIn()) {
        console.log("IS LOGGED IN");
        const accountId = wallet.getAccountId();
        //dom.btnHello.addEventListener('click', contract.getEstudiantes);
        dom.btnHello.addEventListener('click', contract.helloWorld);
        dom.btnRead.addEventListener('click', contract.readKey);
        dom.btnWrite.addEventListener('click', contract.writeKey);

        dom.studentList.addEventListener('click', contract.studentList);
        dom.getById.addEventListener('click', contract.getStudent);
        dom.getByName.addEventListener('click', contract.getByName);
        dom.getByCareer.addEventListener('click', contract.getByCareer);
        
        dom.addStudent.addEventListener('click', contract.addStudent);

      }

      async function change(contract, method, args, gas, amount) {
        console.log('attempting to send signed transaction ...');
        const response = await wallet.account().functionCall(contract, method, args, gas, amount);
        console.log('response received.');

        const { transaction_outcome: txo, status } = response;

        console.log(`gas burned: ${txo.outcome.gas_burnt}`);
        console.log(`tokens burned: ${txo.outcome.tokens_burnt}`);
        console.log(`logs: \n${txo.outcome.logs}`);

        const { SuccessValue: value } = status;
        console.log(b64DecodeUnicode(value)); // see helper functions below
      }

      async function view(contract, method, args) {
        console.log("MANDO A LLAMAR LA VIEW");
        const response = await wallet.account().viewFunction(contract, method, args);
        console.log(response);
      }

      function config() {
        return {
          networkId: 'testnet',
          keyStore: new keyStores.BrowserLocalStorageKeyStore(),
          nodeUrl: 'https://rpc.testnet.near.org',
          walletUrl: 'https://wallet.testnet.near.org',
          helperUrl: 'https://helper.testnet.near.org',
          explorerUrl: 'https://explorer.testnet.near.org'
        };
      }

      function setupDOMBindings() {
        return {
          btnHello: document.querySelector('#hello'),
          btnRead: document.querySelector('#read'),
          txtReadKey: document.querySelector('#read-key'),
          btnWrite: document.querySelector('#write'),
          txtWriteKey: document.querySelector('#write-key'),
          txtWriteValue: document.querySelector('#write-value'),

          addStudent: document.querySelector('#addStudent'),
          studentList: document.querySelector('#studentList'),
          getByName: document.querySelector('#readName'),
          getById: document.querySelector('#readId'),
          getByCareer: document.querySelector('#readCareer'),
          txtgetByName: document.querySelector('#read-name'),
          txtgetByCareer: document.querySelector('#read-career'),
          txtgetByid: document.querySelector('#read-id'),
        };
      }

      // ------------------------
      // see here for decoding simple ASCII response https://stackoverflow.com/q/33854103/2836874
      // see here for decoding UTF-8 data in response (eg. if you want emoji support) https://stackoverflow.com/a/30106551/2836874
      // ------------------------
      // Encoding UTF8 ⇢ base64
      function b64EncodeUnicode(str) {
        return btoa(
          encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (match, p1) {
            return String.fromCharCode(parseInt(p1, 16));
          })
        );
      }

      // Decoding base64 ⇢ UTF8
      function b64DecodeUnicode(str) {
        return decodeURIComponent(
          Array.prototype.map
            .call(atob(str), function (c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join('')
        );
      }
    })();
  </script>
</body>

</html>